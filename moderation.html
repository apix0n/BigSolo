<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administration - Modération</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        background-color: #f8f9fa;
        color: #333;
      }
      .container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 1rem;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }
      h1 {
        margin: 0;
      }
      #logout-btn,
      #save-changes-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
      }
      #logout-btn {
        background: #6c757d;
      }
      #logout-btn:hover {
        background: #5a6268;
      }
      #save-changes-btn {
        background: #28a745;
        display: none;
      } /* Caché par défaut */
      #save-changes-btn:hover {
        background: #218838;
      }
      #status {
        text-align: center;
        font-size: 1.2rem;
        padding: 2rem;
      }
      #comments-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      #comments-table th,
      #comments-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
        transition: all 0.3s ease;
      }
      #comments-table th {
        background-color: #f1f3f5;
      }
      #comments-table td:last-child {
        text-align: center;
      }
      .comment-content {
        max-width: 400px;
        word-wrap: break-word;
      }
      .action-btn {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 5px;
      }
      .delete-btn {
        color: #dc3545;
      }
      .delete-btn:hover {
        color: #c82333;
      }
      .undo-btn {
        color: #ffc107;
      }
      .undo-btn:hover {
        color: #e0a800;
      }
      .marked-for-deletion {
        opacity: 0.4;
        background-color: #fff3cd;
      }
      .marked-for-deletion td {
        text-decoration: line-through;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Modération des Commentaires</h1>
        <div>
          <button id="save-changes-btn">
            Sauvegarder les changements (<span id="pending-count">0</span>)
          </button>
          <button id="logout-btn">Déconnexion</button>
        </div>
      </header>

      <div id="comments-container">
        <p id="status">Chargement des commentaires...</p>
        <table id="comments-table" style="display: none">
          <thead>
            <tr>
              <th>Série / Chapitre</th>
              <th>Auteur</th>
              <th>Commentaire</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="comments-tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      const token = sessionStorage.getItem("admin_token");
      const statusElement = document.getElementById("status");
      const tableElement = document.getElementById("comments-table");
      const tbodyElement = document.getElementById("comments-tbody");
      const logoutBtn = document.getElementById("logout-btn");
      const saveBtn = document.getElementById("save-changes-btn");
      const pendingCountSpan = document.getElementById("pending-count");

      let deletionQueue = [];

      function updatePendingCount() {
        const count = deletionQueue.length;
        pendingCountSpan.textContent = count;
        saveBtn.style.display = count > 0 ? "inline-block" : "none";
      }

      async function sendDeletionQueue() {
        if (deletionQueue.length === 0) return;

        console.log(
          `Envoi de ${deletionQueue.length} suppressions en attente...`
        );
        try {
          navigator.sendBeacon(
            "/api/admin/batch-delete",
            JSON.stringify(deletionQueue)
          );
          // Utilisation de sendBeacon pour une fiabilité maximale à la fermeture.
          // sendBeacon ne permet pas d'envoyer des headers custom, nous devons donc ajuster l'API pour cela.
          // Pour la simplicité, restons sur fetch avec keepalive.
          fetch("/api/admin/batch-delete", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(deletionQueue),
            keepalive: true,
          });
          deletionQueue = []; // Vider la file d'attente de manière optimiste
        } catch (e) {
          console.error("Erreur lors de l'envoi de la file de suppression", e);
          // La file n'est pas vidée et sera renvoyée à la prochaine session.
        }
      }

      window.addEventListener("pagehide", sendDeletionQueue);
      saveBtn.addEventListener("click", () => {
        sendDeletionQueue();
        alert("Changements sauvegardés en arrière-plan !");
        updatePendingCount();
      });

      logoutBtn.addEventListener("click", () => {
        if (deletionQueue.length > 0) {
          if (
            confirm(
              "Vous avez des changements non sauvegardés. Voulez-vous les sauvegarder avant de vous déconnecter ?"
            )
          ) {
            sendDeletionQueue();
          }
        }
        sessionStorage.removeItem("admin_token");
        window.location.href = "/admin.html";
      });

      async function loadComments() {
        if (!token) {
          window.location.href = "/admin.html";
          return;
        }
        // ... (le reste de la fonction loadComments est identique)
      }
      // ... (le reste du script reste pareil jusqu'à displayComments)

      function displayComments(comments) {
        if (comments.length === 0) {
          statusElement.textContent = "Aucun commentaire à modérer.";
          return;
        }

        statusElement.style.display = "none";
        tableElement.style.display = "table";
        tbodyElement.innerHTML = "";

        comments.forEach((comment) => {
          const row = document.createElement("tr");
          row.dataset.commentId = comment.id;
          row.dataset.seriesSlug = comment.seriesSlug;
          row.dataset.chapterNumber = comment.chapterNumber;

          const date = new Date(comment.timestamp).toLocaleString("fr-FR");

          row.innerHTML = `
                    <td>${comment.seriesSlug}<br><strong>Ch. ${
            comment.chapterNumber
          }</strong></td>
                    <td>${comment.username}</td>
                    <td class="comment-content">${comment.comment
                      .replace(/</g, "<")
                      .replace(/>/g, ">")}</td>
                    <td>${date}</td>
                    <td>
                        <button class="action-btn delete-btn" title="Marquer pour suppression">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
          tbodyElement.appendChild(row);
        });
      }

      // MODIFICATION MAJEURE : Nouvelle logique de gestion des clics
      tbodyElement.addEventListener("click", (e) => {
        const btn = e.target.closest(".action-btn");
        if (!btn) return;

        const row = btn.closest("tr");
        const { commentId, seriesSlug, chapterNumber } = row.dataset;
        const deletionAction = { commentId, seriesSlug, chapterNumber };

        if (btn.classList.contains("delete-btn")) {
          // Ajouter à la file d'attente
          deletionQueue.push(deletionAction);

          // Mettre à jour l'UI
          row.classList.add("marked-for-deletion");
          btn.classList.remove("delete-btn");
          btn.classList.add("undo-btn");
          btn.title = "Annuler la suppression";
          btn.innerHTML = `<i class="fas fa-undo"></i>`;
        } else if (btn.classList.contains("undo-btn")) {
          // Retirer de la file d'attente
          deletionQueue = deletionQueue.filter(
            (item) => item.commentId !== commentId
          );

          // Mettre à jour l'UI
          row.classList.remove("marked-for-deletion");
          btn.classList.remove("undo-btn");
          btn.classList.add("delete-btn");
          btn.title = "Marquer pour suppression";
          btn.innerHTML = `<i class="fas fa-trash-alt"></i>`;
        }
        updatePendingCount();
      });

      // Coller ici le reste du script original (loadComments, etc.)
      (async function init() {
        if (!token) {
          window.location.href = "/admin.html";
          return;
        }
        try {
          console.log("Chargement des commentaires...");
          const response = await fetch("/api/admin/comments", {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (response.status === 401) {
            sessionStorage.removeItem("admin_token");
            window.location.href = "/admin.html";
            return;
          }
          if (!response.ok)
            throw new Error(`Erreur serveur: ${response.status}`);
          const comments = await response.json();
          console.log(`Affichage de ${comments.length} commentaires.`);
          displayComments(comments);
        } catch (error) {
          statusElement.textContent =
            "Erreur lors du chargement des commentaires.";
          console.error(error);
        }
      })();
    </script>
  </body>
</html>
